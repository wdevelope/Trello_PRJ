// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§ÌñâÎê† Ìï®Ïàò
document.addEventListener("DOMContentLoaded", function () {
  const userId = sessionStorage.getItem("userId");
  if (userId) {
    loadAndRenderBoards(userId);
  } else {
    console.log("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
  }
});

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î†åÎçîÎßÅ
function loadAndRenderBoards(userId) {
  fetch(`http://localhost:3000/board/${userId}`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: sessionStorage.getItem("Authorization"),
    },
  })
    .then((response) => {
      if (!response.ok) {
        return response.text().then((errorText) => {
          throw new Error(
            errorText || "Authentication failed or user not found.",
          );
        });
      }
      return response.json();
    })
    .then((data) => {
      const mainSection = document.querySelector("main");
      data.forEach((board) => {
        const modalId = `addColumnModal-${board.id}`;
        const columnTitleId = `columnTitle-${board.id}`;
        const columnPositionId = `columnPosition-${board.id}`;

        const boardHtml = `
                            <div id="mainBoard" data-board-id="${board.id}" class="board w-100 p-3 mt-5 border">
                              <div style="background-color:${board.color}" class="board w-100 p-3 mt-5 border">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                  <h1>${board.title}</h1>
                                  <div class="d-flex align-items-center">
                                    <p class="mb-1 mr-3">Ï∞∏Ïó¨Ï§ëÏù∏ Ïú†Ï†Ä :</p>
                                    <button data-toggle="modal" data-target="#inviteUserModal" class="btn btn-primary mb-1 mr-3">
                                      Ïú†Ï†Ä Ï¥àÎåÄ
                                    </button>
                                    <button data-toggle="modal" data-target="#${modalId}" class="btn btn-primary mb-1 btn-add-column" data-board-id="${board.id}">
                                      Ïª¨Îüº Ï∂îÍ∞Ä
                                    </button>
                                  </div>
                                </div>
                                <div class="description">
                                  ${board.description}
                                </div>
                              </div>
                              <div class="modal fade" id="${modalId}">
                                <div class="modal-dialog">
                                  <div class="modal-content">
                                    <div class="modal-body">
                                      <label for="${columnTitleId}">Ïª¨Îüº Ï†úÎ™©</label>
                                      <input type="text" id="${columnTitleId}" placeholder="Ïª¨Îüº Ï†úÎ™©" class="form-control mb-2" />
                                      <label for="${columnPositionId}">Ïª¨Îüº ÏúÑÏπò</label>
                                      <input type="number" id="${columnPositionId}" placeholder="Ïª¨Îüº ÏúÑÏπò (Ïòà: 1)" class="form-control mb-2" />
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-primary" onclick="createColumn(${board.id})">Ï∂îÍ∞Ä</button>
                                      <button type="button" class="btn btn-danger" data-dismiss="modal">Îã´Í∏∞</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="columns-container"></div>
                            </div>
                          `;

        mainSection.insertAdjacentHTML("beforeend", boardHtml);
        loadColumn(board.id);
      });
    })
    .catch((error) => {
      console.error("Error fetching boards:", error);
      alert("Î≥¥Îìú Î∂àÎü¨Ïò§Í∏∞ Ï§ë ÏóêÎü¨ Î∞úÏÉù: " + error.message);
    });
}

//Ïª¨Îüº ÏÉùÏÑ±
async function createColumn(boardId) {
  const obj = {};
  obj.title = document.getElementById(`columnTitle-${boardId}`).value;
  obj.position = document.getElementById(`columnPosition-${boardId}`).value;

  const option = {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: sessionStorage.getItem("Authorization"),
    },
    body: JSON.stringify(obj),
  };

  try {
    const fetchedData = await fetch(
      `http://localhost:3000/board/${boardId}/column`,
      option,
    ).then((data) => {
      return data.json();
    });
    location.reload();
  } catch (e) {
    console.error(e);
  }
}

//Ïª¨Îüº Ï°∞Ìöå
async function loadColumn(boardId) {
  if (!boardId) {
    console.error("No boardId provided to loadColumn function.");
    return;
  }
  const option = {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: sessionStorage.getItem("Authorization"),
    },
  };

  const response = await fetch(
    `http://localhost:3000/board/${boardId}/column`,
    option,
  );
  if (!response) {
    console.error(
      `Failed to load columns for boardId: ${boardId}. Status: ${response.status}`,
    );
    return;
  }

  const columnData = await response.json();
  const columns = columnData.data || columnData;

  // position Í∞íÏóê Îî∞Îùº Ïª¨ÎüºÏùÑ Ï†ïÎ†¨
  columns.sort((a, b) => a.position - b.position);

  const container = document.querySelector(
    `#mainBoard[data-board-id="${boardId}"] .columns-container`,
  );
  if (!container) {
    console.error(`Failed to find the container for boardId: ${boardId}.`);
    return;
  }

  container.innerHTML = "";
  columns.forEach((data) => {
    const columnDiv = document.createElement("div");
    columnDiv.classList.add("col-lg-3", "col-md-6", "col-sm-12", "mb-4");

    columnDiv.innerHTML += `
                              <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                              <div class="column h-100 p-2 bg-light rounded">
                                <h4>${data.title}</h4>
                                
                                <button
                                  data-toggle="modal"
                                  data-target="#addCardModal"
                                  class="btn btn-secondary mt-3"
                                >
                                  Ïπ¥Îìú Ï∂îÍ∞Ä
                                </button>
                              </div>
                            </div>

                            <div class="modal fade" id="addCardModal">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h4 class="modal-title">Ïπ¥Îìú Ï∂îÍ∞Ä</h4>
                                  <button type="button" class="close" data-dismiss="modal">
                                    &times;
                                  </button>
                                </div>
                                <div class="modal-body">
                                  <label for="cardTitle">Ïπ¥Îìú Ï†úÎ™©</label>
                                  <input
                                    type="text"
                                    id="cardTitle"
                                    placeholder="Ïπ¥Îìú Ï†úÎ™©"
                                    class="form-control mb-2"
                                  />

                                  <label for="cardContent">Ïπ¥Îìú ÎÇ¥Ïö©</label>
                                  <textarea
                                    id="cardContent"
                                    placeholder="Ïπ¥Îìú ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."
                                    class="form-control mb-2"
                                    rows="3"
                                  ></textarea>

                                  <label for="dueDate">ÎßàÍ∞êÏùº</label>
                                  <input
                                    type="date"
                                    id="dueDate"
                                    placeholder="ÎßàÍ∞êÏùº"
                                    class="form-control mb-2"
                                  />

                                  <label for="cardColor">ÏÉâÍπî</label>
                                  <input type="color" id="cardColor" class="form-control mb-2" />

                                  <label for="cardPosition">ÏàúÏÑú</label>
                                  <input
                                    type="number"
                                    id="cardPosition"
                                    placeholder="ÏàúÏÑú (Ïòà: 1)"
                                    class="form-control mb-2"
                                  />
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-primary"onclick="addCard()">
                                    Ï∂îÍ∞Ä
                                  </button>
                                  <button type="button" class="btn btn-danger" data-dismiss="modal">
                                    Îã´Í∏∞
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        `;
    container.appendChild(columnDiv);
  });
}

// üìö ÏÉàÎ°úÏö¥ Î≥¥Îìú ÏÉùÏÑ±
async function createBoard() {
  const title = document.getElementById("titleBoard").value;
  const description = document.getElementById("descriptionBoard").value;
  const color = document.getElementById("colorBoard").value;
  // ÌÜ†ÌÅ∞Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
  const token = sessionStorage.getItem("Authorization");

  try {
    const response = await fetch("http://localhost:3000/board", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token,
      },
      body: JSON.stringify({ title, description, color }),
    });

    const data = await response.json();

    if (response.status === 201) {
      // Î™®Îã¨ Ï∞ΩÏùÑ Îã´ÏäµÎãàÎã§.
      $("#createBoardModal").modal("hide");

      alert(data.message || "Î≥¥Îìú ÏÉùÏÑ±Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§.");
      location.reload();
    } else {
      alert(data.message || "Î≥¥Îìú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }
  } catch (error) {
    console.error("Î≥¥Îìú ÏóêÎü¨ Î∞úÏÉù:", error);
    alert("Î≥¥Îìú ÏÉùÏÑ± Ï§ë ÏóêÎü¨ Î∞úÏÉù");
  }
}
